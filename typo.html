<!doctype html><html lang="zh-CN" class="night"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=4,user-scalable=0" name="viewport"><title>Edeity&#39;s Blog</title><meta name="description" content="Try to be a qualified programmer"><meta property="og:type" content="website"><meta property="og:description" content="Try to be a qualified programmer"><meta property="og:title" content="Edeity&#39;s Blog"><meta property="og:site_name" content="Edeity&#39;s Blog"><meta property="og:url" content="https://blog.edeity.me"><meta property="og:image" content="https://edeity.oss-cn-shenzhen.aliyuncs.com/public/edeity_o.png"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="mainfest" href="/mainfest.json"><link rel="stylesheet" href="/public/css/common.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_707055_4b9og9sc5lx.css"><script>!function(){var e=-1!==window.location.search.indexOf("theme=night")||"night"===window.localStorage.getItem("edeity-theme_theme"),t=-1!==window.location.search.indexOf("theme=light")||"light"===window.localStorage.getItem("edeity-theme_theme");(new Date).getHours();var n=document.querySelector("html");e?n.classList.add("night"):t?n.classList.remove("night"):n.classList.add("night")}(),document.addEventListener("DOMContentLoaded",function(){null!==document.querySelector("ol.toc")&&(document.querySelector("#nav-bar").style.cssText="display: block")})</script><meta name="generator" content="Hexo 5.0.0"></head><body><div class="loading"></div><div id="switch" data-switch="{&#34;toc&#34;:true,&#34;use_pwa&#34;:false}"></div><header class="fullscreen"><div class="toolbar"><i class="iconfont icon-menu"></i></div><h1><a href="/">Edeity&#39;s Blog</a></h1><div class="head-link"><a class="btn waves" href="/"><span><i class="iconfont icon-home">Home </i></span></a><a class="btn waves" href="/about/index.html"><span><i class="iconfont icon-me">About </i></span></a><a class="btn waves" target="_blank" rel="noopener" href="https://github.com/edeity"><span><i class="iconfont icon-github">Github</i></span></a></div></header><div class="some-link"><a class="btn" id="light-or-not"><i class="iconfont icon-light"></i> </a><a style="display:none" class="btn" id="up-to-top"><i class="iconfont icon-up"></i></a></div><div id="nav-bar" style="display:none"><div class="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE"><span class="toc-number">2.</span> <span class="toc-text">数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%92%E7%89%88"><span class="toc-number">3.</span> <span class="toc-text">排版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93"><span class="toc-number">4.</span> <span class="toc-text">渲染</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%BA%A4%E4%BA%92"><span class="toc-number">5.</span> <span class="toc-text">用户交互</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">6.</span> <span class="toc-text">附录</span></a></li></ol></div></div><main id="content-main" class="section"><div class="list-item"><h1 class="post-title"><a id="「排版软件」浅析" class="article-link" href="">「排版软件」浅析</a></h1><div class="post-meta"><time class="meta published">Apr 21, 2021</time></div><div class="article"><div class="post-excerpt markdown-body"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>离开金山已有两月，在金山两年半的时间里，过得还是比较愉快的，结了婚学了车买了房，也有幸和金山WEB部门一起成长。希望将自己所学或所感悟的东西，在此记录成一篇小文章，作为技术类别的一次回忆。</p><hr><p>对于排版（无论是<strong>排软软件</strong>或浏览器的<strong>排版引擎</strong>），均可用以下<strong>层级</strong>来理解：<small>不受限于何种平台，比如文字的多端（PC Windows/Macos、移动 Android/Ios，Web），均采用这种抽象来划分层级。</small></p><p><img src="https://edeity.oss-cn-shenzhen.aliyuncs.com/2021/typo_layer.svg" alt="排版分层"></p><div class="img-desc">排版分层</div><h2 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h2><p>最底层的是<strong>「数据」</strong>。数据层级的作用，是将原始的数据（比如Word的Docx，一种特殊的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/Office_Open_XML">XML</a>；或者排版引擎的HTML、CSS源文件），转化为计算机容易识别的数据结构。大概涉及两方面的内容：一方面为<strong>解析</strong>，另一方面<strong>结构化</strong>。</p><p>“解析“大多属于编译原理的内容，词法分析，自下而上语法分析，中间码优化等。<small>（最近突然意识到HTML，因为要兼容各种稀奇古怪的DTD语法，竟是一种上下文有关的语法）</small>。</p><p><img src="https://edeity.oss-cn-shenzhen.aliyuncs.com/2021/html_parse_flow.svg" alt="HTML解析过程"></p><div class="img-desc"><a target="_blank" rel="noopener" href="https://html.spec.whatwg.org/">HTML解析过程</a></div><p>”结构化“就是通常意义的数据结构，我所知的：比较均衡的有<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/105368572">区间树</a>（一种针对索引建立缓存的红黑树），或者是<a target="_blank" rel="noopener" href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">碎片表</a>（压缩存储空间）。因为上层的业务操作会频繁触发数据的更新和读取，此层最考验计算机功底。</p><h2 id="排版"><a href="#排版" class="headerlink" title="排版"></a>排版</h2><p>数据有了。那么接下来就是<strong>「排版」</strong>。排版的作用，就是依照一定的<strong>规则</strong>，将数据转化为<strong>元素</strong>。这些元素最基本的特征，就是<code>坐标（x, y）</code>、<code>形状</code>。在我接触的绝大多数情况下，<code>形状</code>都是长方形的（<code>rect(width, height)</code>）。因为长方形能满足常规的排版要求，而且是规则图形，计算量少。而最基本的排版元素，当属<strong>「字体」</strong>。字体虽然很常见，但也可以很复杂。（感兴趣可以查看：字体渲染库<a target="_blank" rel="noopener" href="https://www.freetype.org/freetype2/docs/index.html">FreeType</a>）。不同的产品对字体的理解也存在差异，为了便于理解，我们可以将字体约等于我们前端领域的“盒子”模型。</p><p><img src="https://edeity.oss-cn-shenzhen.aliyuncs.com/2021/font_metrics.png" alt="文字数据"></p><div class="img-desc">FreeType对字体的解析</div><p><code>rect</code>形状决定了元素的长宽。而元素的<strong>坐标</strong>，则依赖于<strong>规则</strong>。最常见的规则，便是「自左而右，自上而下」的流式布局。简单而言，就是将元素顺序从左到右依次排列，元素间紧密不重合。若一行无法放下时，便自上而下另起一行，重新排列。</p><p><img src="https://edeity.oss-cn-shenzhen.aliyuncs.com/2021/typo_left2right.gif" alt="20200822000731775"></p><div class="img-desc">最简单的排版规则：<a target="_blank" rel="noopener" href="https://blog.csdn.net/TriDiamond6/article/details/108278000">图片来源</a></div><p>排版规则的多样性，决定了排版的复杂度。最简单的流式布局，只要稍一改变，就可能带来复杂的变化，比如正常的文字流，遇到图片可以演变为“环绕”的效果，遇到阿拉伯语（从右到左）可以演变为<a target="_blank" rel="noopener" href="http://unicode.org/reports/tr9/tr9-17.html">Bidi标准</a>。同样的布局，也可能来源于不同的描述方式，比如CSS中的<code>inline/blcok</code>、<code>Flex</code>、<code>Grid</code>等。当然，很多时候，元素也会<strong>相交</strong>，由此衍生出<code>层级</code>的概念（比如css中的<code>z-index</code>）。一般而言，不同层级的元素，占用不同的排版空间，互不影响。在文字等排版软件中，排版是作为最核心的存在。</p><h2 id="渲染"><a href="#渲染" class="headerlink" title="渲染"></a>渲染</h2><p>排版后，我们得到了元素的布局属性，这些属性是数值方式存储的。将已具备空间属性的元素在用户前端设备展示的过程，便是<strong>「渲染」</strong>。二维排版的渲染相对3D而言，运算量要少很多。但两者在优化上也可以是相通的，比如常见的优化方式都可以是：局部/分层渲染（只渲染当前视图的内容，或按照主次异步渲染不同图层），离屏渲染/双缓冲（提前完成下一帧计算，并加入到缓冲池中）。</p><p>Web端的渲染，常见有三种载体，分别为：<strong>DOM</strong>（浏览器提供最核心的排版接口），<strong>SVG</strong>（矢量图，在放大缩小方面能保持不失真），<strong>Canvas</strong>（位图，基于像素点）。排版 + 渲染的执行速度，基本上就决定了“帧率”的高低，帧率用户体验上发挥着至关重要的作用。选择DOM，在某种程度可能要受限于已有的排版/渲染规则，但在受限的同时往往将最复杂的问题抛给浏览器，从而减少功能迭代的开发工作量，主流的开源富文本编辑器往往会采用这种方式（比如Prosmirror、Slate等）。而选择Svg或Canvas，则意味着你需要投入人力物力，但也获得了无限可能，商用的排版软件往往采用这种方式（比如金山文档，谷歌文档等）。值得一提，选择Svg还是Canvas，取决于渲染的元素和空间的多少。</p><p><img src="https://edeity.oss-cn-shenzhen.aliyuncs.com/2021/svg_vs_canvas.png" alt="Svg Vs Canvas"></p><div class="img-desc">Svg Vs Canvas，<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/samples/gg193983(v=vs.85)">图片来源</a></div><h2 id="用户交互"><a href="#用户交互" class="headerlink" title="用户交互"></a>用户交互</h2><p>最后，则是<strong>「用户交互」</strong>。这往往是前端工程师和产品们的主战场。从产品角度而言，用户的年轻化，对“兼容”更宽容，而对“体验”更敏感。常见的写作场景，“体验”的高低存在一个重要的因子：<strong>不中断</strong>用户输入，又称为沉浸式，依次诞生了Markdown（尽可能少地关注排版，使双手保持在键盘上的格式），以及Notion（尽可能少地在软件中切换，文档不仅局限于排版，而是包容万物的产品）。</p><p>在<strong>用户交互</strong>层次上，要分享一个关键的逻辑：<strong>「点击测试」</strong>。这是一个建立视图到用户的连接通道。点击测试，可以理解为一个方法：<strong>传入（x，y）坐标，返回当前坐标的元素数据</strong>。某些观点认为，要实现自定义的选区和光标，依赖于自排自绘，这个观点是片面的，自定义光标和选区，依赖于能否有效且精准地“拿到”排版信息，而点击测试正是其中的关键。实践也证明<small>（金山文档）</small>，基于DOM的编辑器也是可以相对精准得到元素数据的排版信息而实现自定义光标和选区的。</p><p>学会了从更高的层级看待事物，而不局促于局部代码，无论对理解浏览器，还是排版软件（或富文本编辑器），都会拥有一个更全面的认知。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>[1] <a target="_blank" rel="noopener" href="http://taligarsiel.com/Projects/howbrowserswork1.htm">浏览器工作原理</a></p><p>[2] <a target="_blank" rel="noopener" href="https://www.w3.org/TR/clreq/">中文排版需求-W3C草稿</a></p></div></div></div><div class="more section"><div class="pre"><a class="article-link" href="/qinghai travel.html"><i class="iconfont icon-right"></i> <span>苦行青海</span></a></div><div class="next"><a class="article-link" href="/2020_sim_and_normal.html">2020 普通人，平常事 <i class="iconfont icon-right"></i></a></div></div></main></body><footer class="section fullscreen"><div class="footer-desc">Edeity © 2015-2021 · powered by hexo</div></footer><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script><script src="/public/js/init.js"></script></html>